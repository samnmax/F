<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
</head>
<body>
    <h2>로그인</h2>
    
    <!-- 로그인 실패 메시지 -->
    <div style="color:red">
        <script>
            if (window.location.search.includes("error")) {
                document.write("아이디 또는 비밀번호가 잘못되었습니다.");
            }
        </script>
    </div>

    <form method="post" action="/login">
        <label>아이디: <input type="text" name="username"></label><br>
        <label>비밀번호: <input type="password" name="password"></label><br>
        <button type="submit">로그인</button>
    </form>

    <a href="/">← 메인으로</a>
</body>
</html>

@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/index.html", "/register.html", "/user/register", "/css/**", "/js/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login.html")              // 우리가 만든 페이지 사용
                .loginProcessingUrl("/login")          // 로그인 POST 처리 경로
                .defaultSuccessUrl("/", true)          // 로그인 성공 후 이동
                .failureUrl("/login.html?error=true")  // 실패 시 다시 로그인 페이지
                .permitAll()
            )
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .invalidateHttpSession(true)
                .clearAuthentication(true)
            );

        return http.build();
    }
}


